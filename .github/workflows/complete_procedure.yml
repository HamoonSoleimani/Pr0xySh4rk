name: Complete Pr0xySh4rk Update

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      GEOIP_URL: "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb"
      CONFIG_LIMIT: 50
      THREADS: 40  # Lowered slightly for stability
      SPEEDTEST_ENABLED: "true"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip
          pip install requests urllib3 tqdm python-dotenv geoip2

      - name: Run Collector (main.py)
        run: |
          python main.py
          if [ ! -s collected_configs.txt ]; then
            echo "::error::Collector failed."
            exit 1
          fi

      - name: Install Tools (Xray-Core, Xray-Knife, GeoIP)
        run: |
          # 1. GeoIP
          wget -q -O Country.mmdb "${{ env.GEOIP_URL }}"

          # 2. Xray-Core (Required engine for xray-knife)
          echo "Installing Xray-Core..."
          wget -q -O xray.zip "https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip"
          unzip -o xray.zip -d xray_core
          mv xray_core/xray .
          chmod +x xray
          rm -rf xray_core xray.zip

          # 3. Xray-Knife (The tester)
          echo "Installing Xray-Knife..."
          LATEST_TAG=$(curl -sL "https://api.github.com/repos/lilendian0x00/xray-knife/releases/latest" | jq -r ".tag_name")
          wget -q -O knife.zip "https://github.com/lilendian0x00/xray-knife/releases/download/${LATEST_TAG}/Xray-knife-linux-64.zip"
          unzip -o knife.zip -d knife_temp
          # Find binary recursively
          KNIFE_BIN=$(find knife_temp -type f -name "xray-knife" | head -n 1)
          mv "$KNIFE_BIN" ./xray-knife
          chmod +x xray-knife
          rm -rf knife_temp knife.zip

          # 4. Verify
          ./xray -version
          ./xray-knife --help > /dev/null && echo "Tools Ready"

      - name: Run Processor (Pr0xySh4rk.py)
        run: |
          # We add the current dir to PATH so xray-knife can find xray executable
          export PATH=$PATH:$(pwd)
          
          python Pr0xySh4rk.py \
            --input collected_configs.txt \
            --output Pr0xySh4rk_SubBase64.txt \
            --output-format base64 \
            --limit ${{ env.CONFIG_LIMIT }} \
            --threads ${{ env.THREADS }} \
            --geoip-db Country.mmdb \
            --xray-knife-path ./xray-knife \
            --xray-knife-insecure \
            --speedtest \
            --csv report.csv

      - name: Commit and Push
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add Pr0xySh4rk_SubBase64.txt
          
          # Clean temp files
          rm -f collected_configs.txt Country.mmdb xray xray-knife report.csv
          
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "Update Proxies: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git pull --rebase --autostash
            git push
          fi
